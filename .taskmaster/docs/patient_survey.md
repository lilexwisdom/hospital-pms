# 환자 사전 설문 상세 명세서

## 📋 개요

병원 진료 예약을 위한 모바일 최적화 설문 시스템입니다. 잠재 환자가 설문을 통해 기본 정보와 건강 상태를 제출하면, 시스템에서 자동으로 환자 데이터를 생성하고 담당 BD에게 알림을 발송합니다.

## 🔗 설문 접근 방식

- **URL 형태**: `https://domain.com/survey/{unique_token}`
- **유효기간**: 24시간
- **접근 방법**: 카카오톡, 문자 등으로 개인화된 링크 발송
- **모바일 최적화**: 스마트폰에서 편리한 입력 환경

## 📱 설문 단계별 구성

### **Step 1: 개인정보 수집 동의**

```
┌─────────────────────────────────┐
│        [병원 로고]               │
│                                 │
│    진료 예약을 위한 사전 설문      │
│                                 │
│   정확한 상담을 위해 아래 정보를   │
│       입력해주세요               │
│                                 │
│    ⏱️ 예상 소요시간: 3-5분       │
│                                 │
│  ☐ 개인정보 수집 및 이용 동의 (필수) │
│  ☐ 의료정보 처리 동의 (필수)       │
│                                 │
│        [다음 단계]              │
└─────────────────────────────────┘
```

**처리 로직**:

- 두 체크박스 모두 선택해야 다음 단계 진행 가능
- 미동의시 설문 진행 불가 메시지 표시

---

### **Step 2: 기본 정보 입력**

#### **필수 입력 항목**

**1. 이름** (필수)

- 입력 형식: 텍스트 (2-100자)
- 유효성 검사: 한글, 영문만 허용
- 에러 메시지: "정확한 이름을 입력해주세요"

**2. 연락처** (필수)

- 입력 형식: `01012345678` (하이픈 없이)
- 자동 포맷팅: 입력시 자동으로 `010-1234-5678` 형태로 표시
- 유효성 검사: 휴대폰 번호 형식 확인
- 중복 확인: 기존 환자 연락처와 중복 체크

**3. 주민등록번호** (필수) ⚠️ **보안 강화**

- 입력 형식: `[______]-[******]`
- **보안 처리**: 뒷자리는 화면에 마스킹 처리 (`***●●●●`)
- 유효성 검사:
  - 주민번호 체크섬 알고리즘 검증
  - 생년월일 유효성 확인
- **본인 인증**: 추후 방법 논의 필요 (휴대폰 인증, 아이핀 등)
- 암호화 저장: AES-256 암호화하여 DB 저장

**4. 주소** (선택) 🏠 **Daum Postcode API 사용**

- **우편번호**: Daum API로 자동 입력
- **도로명주소**: API 선택 결과로 자동 입력
- **상세주소**: 사용자 직접 입력 (동, 호수 등)
- 구현 방식: 팝업 또는 레이어 방식
- 모바일 최적화: 터치 친화적 인터페이스

```html
<!-- 주소 입력 UI 예시 -->
<input
  type="text"
  placeholder="우편번호"
  readonly
  onclick="execDaumPostcode()"
/>
<input type="text" placeholder="도로명주소" readonly />
<input type="text" placeholder="상세주소 (동, 호수 등)" />
<button onclick="execDaumPostcode()">주소 검색</button>
```

---

### **Step 3: 건강 정보 (핵심 단계)**

#### **질환 체크박스** ⚠️ **기본값 설정**

**Default 선택**: "위에 해당하는 사항 없음" (체크된 상태로 시작)

**선택 항목**:

1. ☐ **고혈압**
2. ☐ **당뇨**
3. ☐ **고지혈증**
4. ☐ **항응고제/항혈소판제 복용** (아스피린, 와파린 등)
5. ☐ **천식**
6. ☐ **특정 약물/음식 알러지**
7. ☐ **뇌/심장 질환** (뇌졸중, 협심증, 심근경색 등)
8. ☐ **임신 가능성** (여성 한정 표시)
9. ☑️ **위에 해당하는 사항 없음** ← **기본 선택됨**

**상호 배타적 로직**:

- "해당사항 없음" 선택 시 → 다른 모든 항목 자동 해제
- 다른 항목 선택 시 → "해당사항 없음" 자동 해제
- 최소 1개는 반드시 선택되어야 함

#### **추가 의료 정보** (선택사항)

**1. 추가 질환/수술 이력**

- 입력 형식: 자유 텍스트 (최대 500자)
- 예시 텍스트: "위궤양 수술(2020년), 가족력: 고혈압(부모)"

**2. 현재 복용 약물**

- 입력 형식: 자유 텍스트 (최대 300자)
- 예시 텍스트: "혈압약(아모잘탄), 당뇨약(메트포르민)"

---

### **Step 4: 희망 검사 선택** 🏥 **간소화된 항목**

#### **체크박스 항목** (다중 선택 가능)

1. ☐ **심장검사** (심전도, 심초음파)
2. ☐ **위/대장 내시경**
3. ☐ **CT 촬영**
4. ☐ **MRI 촬영**

#### **기타 희망 검사**

- 입력 형식: 자유 텍스트 (최대 200자)
- 예시: "유방촬영술, 골밀도 검사"

---

### **Step 5: 설문 완료**

```
┌─────────────────────────────────┐
│        ✅ 설문 완료!            │
│                                 │
│   소중한 정보를 주셔서 감사합니다  │
│                                 │
│   담당자가 확인 후 24시간 이내    │
│     연락드리겠습니다             │
│                                 │
│  📞 문의사항: 02-1234-5678      │
│                                 │
│        [창 닫기]                │
└─────────────────────────────────┘
```

## 🔄 설문 제출 후 자동 처리

### **1. 환자 데이터 자동 생성**

```sql
-- patients 테이블에 신규 레코드 생성
INSERT INTO patients (
    patient_number,     -- P+YYYYMMDD+001 자동 생성
    name,
    phone,
    resident_number,    -- AES-256 암호화
    address,
    status,             -- '신규접수'
    assigned_bd_id,     -- 설문 발송한 BD ID
    created_at
) VALUES (...);
```

### **2. 질환 플래그 자동 매핑**

```sql
-- 체크박스 선택에 따른 boolean 플래그 설정
UPDATE patients SET
    flag_hypertension = true,    -- 고혈압 체크시
    flag_diabetes = true,        -- 당뇨 체크시
    flag_hyperlipidemia = true,  -- 고지혈증 체크시
    flag_anticoagulant = true,   -- 항응고제 체크시
    flag_asthma = true,          -- 천식 체크시
    flag_allergy = true,         -- 알러지 체크시
    flag_cardiovascular = true,  -- 뇌심장질환 체크시
    flag_pregnancy = true        -- 임신가능성 체크시 (여성만)
WHERE patient_id = ?;
```

### **3. 의료정보 저장**

```sql
-- medical_records 테이블에 추가 정보 저장
INSERT INTO medical_records (
    patient_id,
    category,           -- 'survey_additional'
    content,            -- 추가 질환/수술이력
    created_by,         -- 'SYSTEM'
    created_at
) VALUES (...);

-- 복용약물 정보도 별도 레코드로 저장
INSERT INTO medical_records (
    patient_id,
    category,           -- 'survey_medications'
    content,            -- 현재 복용 약물
    created_by,         -- 'SYSTEM'
    created_at
) VALUES (...);
```

### **4. 실시간 알림 발송**

- **담당 BD에게 즉시 알림**: "신규 환자 설문 완료 - [환자명]"
- **알림 채널**:
  - 웹 시스템 내 실시간 알림
  - 카카오톡 워크 (선택사항)
  - 이메일 (선택사항)

## 🛡️ 보안 및 검증 요구사항

### **데이터 보안**

- 주민등록번호: AES-256 암호화 저장
- 개인정보: HTTPS 통신 필수
- 설문 토큰: 24시간 만료, 1회 사용 후 무효화

### **입력 검증**

- 프론트엔드: 실시간 유효성 검사
- 백엔드: 추가 검증 및 SQL Injection 방지
- 중복 방지: 동일 연락처 중복 제출 방지

### **접근 제어**

- 유효한 토큰 없이는 설문 접근 불가
- 만료된 토큰 접근시 안내 페이지 표시
- 봇 방지: reCAPTCHA 또는 유사 방식 적용

## 📊 성과 측정 지표

### **설문 관련 KPI**

- 설문 링크 발송 수
- 설문 접속률 (링크 클릭률)
- 설문 완료율 (Step별 이탈률 추적)
- 설문 → 상담 전환율
- 설문 → 예약 확정 전환율

### **품질 지표**

- 설문 완료 소요시간 평균
- 필수 정보 누락률
- 추가 정보 입력률
- 모바일 vs 데스크톱 사용률

## 🔧 기술 구현 고려사항

### **모바일 최적화**

- 반응형 디자인 (Mobile First)
- 터치 친화적 UI/UX
- 키패드 최적화 (숫자 입력시 숫자 키패드)
- 로딩 속도 최적화

### **사용성 개선**

- 진행률 표시 (Step 1/4, 2/4...)
- 자동 저장 기능 (임시 저장)
- 뒤로가기 버튼 지원
- 입력 실수 방지 (확인 다이얼로그)

### **성능 최적화**

- CDN을 통한 정적 리소스 제공
- 이미지 최적화 (WebP 등)
- 지연 로딩 구현
- 캐싱 전략 수립
