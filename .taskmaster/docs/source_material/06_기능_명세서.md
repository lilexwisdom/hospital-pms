# 기능 명세서

## 개요

본 문서는 NextJS/Supabase 기반 병원 환자 관리 시스템의 상세 기능 명세를 정의합니다. 각 기능은 사용자 스토리, 기능 요구사항, 비기능 요구사항으로 구성됩니다.

## 1. 사용자 인증 및 권한 관리

### 1.1 로그인

#### 사용자 스토리
- 시스템 사용자로서 이메일과 비밀번호로 로그인하여 시스템에 접근하고 싶다.

#### 기능 요구사항
- [ ] 이메일/비밀번호 입력 폼 제공
- [ ] 유효성 검사 (이메일 형식, 비밀번호 복잡도)
- [ ] 로그인 실패 시 구체적인 오류 메시지 표시
- [ ] 5회 실패 시 계정 잠금
- [ ] "비밀번호 찾기" 링크 제공
- [ ] "로그인 상태 유지" 옵션
- [ ] 로그인 성공 시 역할에 맞는 대시보드로 이동

#### 비기능 요구사항
- 응답 시간: 2초 이내
- 보안: HTTPS 통신, 비밀번호 해싱
- 사용성: 엔터키로 로그인 가능

### 1.2 비밀번호 관리

#### 사용자 스토리
- 비밀번호를 잊어버린 경우 이메일로 재설정 링크를 받고 싶다.
- 최초 로그인 시 임시 비밀번호를 변경하고 싶다.

#### 기능 요구사항
- [ ] 비밀번호 재설정 요청 폼
- [ ] 이메일로 재설정 링크 발송 (24시간 유효)
- [ ] 새 비밀번호 설정 시 규칙 검증
  - 최소 12자 이상
  - 대문자, 소문자, 숫자, 특수문자 포함
  - 이전 비밀번호와 다름
- [ ] 비밀번호 변경 성공 알림
- [ ] 비밀번호 변경 시 기존 세션 종료

### 1.3 세션 관리

#### 기능 요구사항
- [ ] 30분 동안 활동 없을 시 자동 로그아웃
- [ ] 세션 만료 5분 전 경고 표시
- [ ] 세션 연장 옵션 제공
- [ ] 다중 기기 로그인 시 이전 세션 종료 옵션

## 2. 환자 관리

### 2.1 환자 등록

#### 사용자 스토리
- 대외협력이사로서 신규 환자 정보를 시스템에 등록하고 싶다.

#### 기능 요구사항
- [ ] 환자 기본정보 입력
  - 이름 (필수, 2-50자)
  - 연락처 (필수, 중복 확인)
  - 주민등록번호 (필수, 암호화 저장)
  - 주소 (선택)
- [ ] 실시간 입력 검증
- [ ] 중복 환자 확인 (이름+연락처)
- [ ] 환자번호 자동 생성 (P+날짜+일련번호)
- [ ] 등록 완료 시 환자 상세 페이지로 이동

#### 비기능 요구사항
- 응답 시간: 1초 이내
- 데이터 정합성: 트랜잭션 처리
- 보안: 주민등록번호 AES-256 암호화

### 2.2 환자 검색 및 조회

#### 사용자 스토리
- 직원으로서 다양한 조건으로 환자를 검색하고 목록을 확인하고 싶다.

#### 기능 요구사항
- [ ] 검색 조건
  - 환자명 (부분 일치)
  - 연락처 (부분 일치)
  - 환자번호 (정확 일치)
  - 상태별 필터
  - 등록일 범위
  - 질환 플래그
- [ ] 검색 결과 정렬
  - 등록일 (기본: 최신순)
  - 환자명
  - 상태
- [ ] 페이지네이션 (20건씩)
- [ ] 검색 결과 내보내기 (Excel)
- [ ] 빠른 검색 (상단 검색바)

#### 역할별 제한
- BD: 본인 담당 환자만 조회
- CS: CS 인계된 환자만 조회
- Manager/Admin: 전체 조회

### 2.3 환자 상세 정보

#### 기능 요구사항
- [ ] 기본 정보 표시
- [ ] 의료 정보 탭
  - 과거력/가족력
  - 복약 정보
  - 수술 이력
  - 알러지 정보
- [ ] 상담 이력 탭
  - 시간순 정렬
  - 상담 유형별 아이콘
- [ ] 예약 정보 탭
  - 예약 현황
  - 예약 변경 이력
- [ ] 정보 수정 권한 체크

### 2.4 환자 상태 관리

#### 사용자 스토리
- 직원으로서 환자의 진행 상태를 업데이트하고 추적하고 싶다.

#### 기능 요구사항
- [ ] 상태 변경 드롭다운
  - 신규접수 → CS팀인계
  - CS팀인계 → 예약조율중
  - 예약조율중 → 예약확정
  - 예약확정 → 검사완료/취소/노쇼
- [ ] 상태 변경 시 자동 처리
  - CS 인계 시 담당자 알림
  - 인계 시간 자동 기록
  - 상태 변경 이력 저장
- [ ] 상태별 색상 구분 표시

## 3. 의료 정보 관리

### 3.1 의료 정보 등록

#### 사용자 스토리
- 직원으로서 환자와의 상담을 통해 파악한 의료 정보를 체계적으로 기록하고 싶다.

#### 기능 요구사항
- [ ] 의료 정보 카테고리
  - 과거력 (질환 이력)
  - 가족력 (가족 질환)
  - 복약정보 (현재 복용 약물)
  - 수술이력 (수술 경험)
  - 알러지 (약물/음식 알러지)
- [ ] 각 카테고리별 입력 폼
- [ ] 자유 텍스트 입력 (최대 2000자)
- [ ] 작성자 및 작성일시 자동 기록
- [ ] 수정 이력 관리

### 3.2 질환 플래그 자동 업데이트

#### 기능 요구사항
- [ ] 키워드 기반 자동 플래그 설정
  - 고혈압: "고혈압", "혈압약" 등
  - 당뇨: "당뇨", "인슐린" 등
  - 고지혈증: "고지혈증", "콜레스테롤" 등
  - 항응고제: "아스피린", "와파린" 등
  - 천식: "천식" 등
  - 알러지: "알러지", "알레르기" 등
  - 뇌심장질환: "뇌졸중", "심장질환" 등
- [ ] 플래그 수동 수정 가능
- [ ] 플래그 변경 시 확인 다이얼로그

## 4. 상담 관리

### 4.1 상담 기록 작성

#### 사용자 스토리
- 직원으로서 환자와의 모든 커뮤니케이션을 기록하고 추적하고 싶다.

#### 기능 요구사항
- [ ] 상담 정보 입력
  - 상담 일시 (기본: 현재 시간)
  - 상담 방법 (전화/문자/카카오톡/방문)
  - 상담 내용 (필수, 최소 10자)
  - 후속 조치 사항 (선택)
- [ ] 빠른 상담 기록 버튼
- [ ] 템플릿 기능
  - 자주 사용하는 문구 저장
  - 상담 유형별 템플릿
- [ ] 상담 기록 수정 불가 (추가만 가능)

### 4.2 상담 이력 조회

#### 기능 요구사항
- [ ] 시간순 정렬 (최신순)
- [ ] 상담 방법별 필터
- [ ] 작성자별 필터
- [ ] 기간별 조회
- [ ] 상담 내용 검색
- [ ] 인쇄용 보기

## 5. 예약 관리

### 5.1 예약 생성

#### 사용자 스토리
- CS 직원으로서 환자와 협의한 검사 일정을 시스템에 등록하고 싶다.

#### 기능 요구사항
- [ ] 예약 정보 입력
  - 예약 날짜 (달력 선택)
  - 예약 시간 (30분 단위)
  - 검사 항목 (다중 선택)
  - 특이사항 메모
- [ ] 예약 가능 시간 확인
  - 이미 예약된 시간 비활성화
  - 검사별 소요시간 고려
- [ ] 예약 충돌 검사
- [ ] 예약 확정 시 환자 상태 자동 변경
- [ ] 예약 확인서 출력

### 5.2 예약 변경/취소

#### 기능 요구사항
- [ ] 예약 변경
  - 날짜/시간 변경
  - 검사 항목 변경
  - 변경 사유 필수 입력
- [ ] 예약 취소
  - 취소 사유 필수 입력
  - 환자 상태 자동 변경
- [ ] 변경/취소 이력 저장
- [ ] 변경/취소 시 알림

### 5.3 예약 현황 관리

#### 사용자 스토리
- 직원으로서 일자별 예약 현황을 한눈에 파악하고 싶다.

#### 기능 요구사항
- [ ] 캘린더 뷰
  - 월간/주간/일간 보기
  - 예약 건수 표시
  - 드래그 앤 드롭으로 일정 변경
- [ ] 리스트 뷰
  - 오늘의 예약 목록
  - 예약 상태별 색상 구분
  - 체크인 기능
- [ ] 예약 리마인더
  - 예약 전날 알림
  - No-show 위험 환자 표시

## 6. 설문 관리

### 6.1 설문 URL 생성

#### 사용자 스토리
- 대외협력이사로서 잠재 환자에게 보낼 개인화된 설문 링크를 생성하고 싶다.

#### 기능 요구사항
- [ ] 원클릭 URL 생성
- [ ] 생성된 URL 정보
  - 고유 토큰
  - 생성 일시
  - 만료 일시 (24시간)
  - 복사 버튼
- [ ] QR 코드 생성
- [ ] 카카오톡 공유 버튼
- [ ] 생성 이력 관리

### 6.2 설문 응답 관리

#### 기능 요구사항
- [ ] 설문 응답 목록
  - 제출 일시
  - 응답자 정보
  - 토큰 상태
- [ ] 응답 상세 보기
- [ ] 잘못된 응답 삭제
  - 삭제 사유 필수 입력
  - 관련 데이터 연쇄 삭제
- [ ] 응답 데이터 환자 정보로 자동 전환
  - 설문 제출 즉시 환자 레코드 생성
  - 건강정보 체크박스 → 질환 플래그 자동 매핑
  - 추가 의료정보 → medical_records 테이블 자동 저장
  - 복용 약물 정보 → medical_records 테이블 자동 저장

### 6.3 환자 설문 폼

#### 기능 요구사항
- [ ] 단계별 입력
  1. 개인정보 동의
  2. 기본 정보 (이름, 연락처, 주민번호, 주소)
  3. 건강 정보
     - 체크박스 선택 (필수, 최소 1개)
       - 고혈압
       - 당뇨
       - 고지혈증
       - 항응고제/항혈소판제 복용
       - 천식
       - 특정 약물/음식 알러지
       - 뇌/심장 질환
       - 임신 가능성 (여성)
       - 위에 해당하는 사항 없음
     - 추가 질환/수술이력 텍스트 입력 (선택)
     - 현재 복용 약물 텍스트 입력 (선택)
  4. 희망 검사 선택
- [ ] 진행률 표시
- [ ] 실시간 유효성 검사
  - "위에 해당하는 사항 없음" 선택 시 다른 항목 자동 해제
  - 다른 항목 선택 시 "위에 해당하는 사항 없음" 자동 해제
- [ ] 자동 저장 (세션 스토리지)
- [ ] 모바일 최적화 UI
- [ ] 제출 완료 페이지

### 6.4 설문-환자 자동 연결 플로우

#### 사용자 스토리
- 대외협력이사로서 환자가 설문을 제출하면 즉시 환자정보 관리창에서 해당 데이터를 확인하고 상담을 시작하고 싶다.

#### 상세 플로우
1. **설문 제출 시점**
   - 환자가 설문 폼 제출
   - 서버에서 데이터 유효성 검증
   - 토큰 유효성 확인 (만료/중복 체크)

2. **자동 데이터 처리 (트랜잭션)**
   - patients 테이블에 신규 환자 생성
     - 고유 환자번호 자동 생성 (P+날짜+일련번호)
     - 상태: '신규접수'
     - 담당 BD: 토큰 생성자
   - 건강정보 매핑
     - '고혈압' → has_hypertension = true
     - '당뇨' → has_diabetes = true
     - '고지혈증' → has_hyperlipidemia = true
     - '항응고제/항혈소판제 복용' → has_anticoagulant = true
     - '천식' → has_asthma = true
     - '특정 약물/음식 알러지' → has_allergy = true
     - '뇌/심장 질환' → has_brain_heart_disease = true
     - '임신 가능성' → has_pregnancy_possibility = true
   - medical_records 자동 생성
     - 추가 질환/수술이력 → type: '과거력'
     - 현재 복용 약물 → type: '복약정보'
   - consultation_logs에 자동 기록
     - "설문을 통한 신규 환자 등록"

3. **실시간 알림**
   - 담당 대외협력이사에게 실시간 알림
   - 대시보드 '최근 설문 응답' 위젯 업데이트
   - 브라우저 푸시 알림 (활성화 시)

4. **즉시 접근 가능**
   - 환자 목록에 즉시 표시
   - 환자 상세 페이지에서 설문 응답 데이터 하이라이트
   - 상담 시작 버튼 활성화

#### 기능 요구사항
- [ ] 원자적 트랜잭션 처리
  - 모든 데이터 생성이 성공하거나 전체 롤백
- [ ] 실시간 데이터 동기화
  - Supabase Realtime 활용
  - 30초 이내 대시보드 반영
- [ ] 중복 제출 방지
  - 토큰 상태 검증
  - 동일 연락처 중복 체크
- [ ] 오류 처리
  - 실패 시 명확한 에러 메시지
  - 부분 실패 방지
- [ ] 감사 로그
  - 설문 제출 → 환자 생성 전 과정 기록

## 7. 통계 및 대시보드

### 7.1 실시간 대시보드

#### 사용자 스토리
- 관리자로서 병원 운영 현황을 실시간으로 모니터링하고 싶다.

#### 기능 요구사항
- [ ] 핵심 지표 위젯
  - 전체 환자 수
  - 오늘 예약 건수
  - 이번 달 신규 환자
  - 예약 전환율
- [ ] 실시간 업데이트 (10초 간격)
- [ ] 기간 선택 (오늘/주간/월간/연간)
- [ ] 차트 시각화
  - 환자 유입 추이
  - 검사 항목별 분포
  - 시간대별 예약 현황
- [ ] 위젯 커스터마이징

### 7.2 역할별 통계

#### BD 통계
- [ ] 개인 실적
  - 신규 등록 환자 수
  - CS 인계 건수
  - 최종 검사 완료율
- [ ] 목표 대비 달성률
- [ ] 일일/주간/월간 비교

#### CS 통계
- [ ] 팀 실적
  - 인계 받은 환자 수
  - 예약 확정률
  - No-show 비율
- [ ] 개인별 성과
- [ ] 예약 리드타임 분석

### 7.3 보고서 생성

#### 기능 요구사항
- [ ] 정기 보고서 템플릿
  - 월간 운영 보고서
  - 주간 실적 보고서
  - 일일 현황 보고서
- [ ] 커스텀 보고서 생성
- [ ] 보고서 스케줄링
- [ ] 이메일 자동 발송
- [ ] PDF/Excel 내보내기

## 8. 알림 시스템

### 8.1 실시간 알림

#### 기능 요구사항
- [ ] 알림 유형
  - 신규 환자 등록
  - CS 인계 알림
  - 예약 확정/변경/취소
  - 시스템 공지
- [ ] 알림 표시 방법
  - 인앱 알림 (벨 아이콘)
  - 브라우저 푸시 알림
  - 이메일 알림
- [ ] 알림 설정
  - 유형별 on/off
  - 알림 시간대 설정
- [ ] 알림 이력 보관 (30일)

### 8.2 예약 리마인더

#### 기능 요구사항
- [ ] 자동 리마인더
  - 예약 1일 전 오후 3시
  - 예약 당일 오전 9시
- [ ] 발송 채널
  - SMS (문자)
  - 카카오 알림톡
- [ ] 발송 이력 관리
- [ ] 발송 실패 시 재시도

## 9. 시스템 관리

### 9.1 사용자 관리

#### 기능 요구사항
- [ ] 사용자 등록
  - 기본 정보 입력
  - 역할 지정
  - 임시 비밀번호 발급
- [ ] 사용자 목록
  - 상태별 필터 (활성/비활성)
  - 역할별 필터
  - 부서별 그룹핑
- [ ] 사용자 정보 수정
- [ ] 계정 활성화/비활성화
- [ ] 접속 이력 조회

### 9.2 권한 관리

#### 기능 요구사항
- [ ] 역할별 권한 설정
- [ ] 메뉴 접근 권한
- [ ] 데이터 접근 범위
- [ ] 기능 사용 권한
- [ ] 권한 변경 이력

### 9.3 시스템 설정

#### 기능 요구사항
- [ ] 병원 정보 관리
- [ ] 검사 항목 관리
  - 항목 추가/수정/삭제
  - 가격 설정
  - 소요시간 설정
- [ ] 업무 시간 설정
- [ ] 공휴일 관리
- [ ] 시스템 공지사항

### 9.4 감사 로그

#### 기능 요구사항
- [ ] 로그 조회
  - 사용자별
  - 기능별
  - 기간별
- [ ] 민감정보 접근 로그
- [ ] 시스템 변경 로그
- [ ] 로그 내보내기
- [ ] 이상 행위 탐지

## 10. 모바일 대응

### 10.1 반응형 디자인

#### 기능 요구사항
- [ ] 브레이크포인트
  - Mobile: < 768px
  - Tablet: 768px - 1024px
  - Desktop: > 1024px
- [ ] 터치 최적화
  - 버튼 크기 (최소 44px)
  - 스와이프 제스처
- [ ] 모바일 전용 UI
  - 하단 네비게이션
  - 플로팅 액션 버튼

### 10.2 PWA 기능

#### 기능 요구사항
- [ ] 홈 화면 추가
- [ ] 오프라인 기본 동작
- [ ] 푸시 알림
- [ ] 자동 업데이트

## 11. 성능 요구사항

### 페이지 로딩
- 초기 로딩: 3초 이내
- 페이지 전환: 1초 이내
- API 응답: 2초 이내

### 동시 사용자
- 최소: 50명 동시 접속
- 목표: 200명 동시 접속

### 데이터 처리
- 환자 검색: 10만 건 기준 1초 이내
- 보고서 생성: 1만 건 기준 5초 이내

## 12. 보안 요구사항

### 데이터 보안
- [ ] 전송 구간 암호화 (TLS 1.3)
- [ ] 저장 데이터 암호화
- [ ] 주민번호 별도 암호화
- [ ] 정기 보안 스캔

### 접근 제어
- [ ] 2단계 인증 (선택)
- [ ] IP 기반 접근 제한
- [ ] 세션 타임아웃
- [ ] 동시 로그인 제한

### 규정 준수
- [ ] 개인정보보호법 준수
- [ ] 의료법 준수
- [ ] GDPR 준수 (해당 시)

## 13. 백업 및 복구

### 백업 정책
- [ ] 일일 전체 백업
- [ ] 시간별 증분 백업
- [ ] 30일 보관
- [ ] 이중화 저장

### 복구 절차
- [ ] RTO: 4시간 이내
- [ ] RPO: 1시간 이내
- [ ] 복구 테스트 (분기별)

---

본 문서는 병원 환자 관리 시스템의 전체 기능을 상세히 정의합니다. 각 기능은 개발 시 체크리스트로 활용되며, 테스트 케이스 작성의 기준이 됩니다.